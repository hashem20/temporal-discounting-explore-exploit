%% task load
clear all; clc;
directory = '/Users/hashem/MATLAB-Drive/git_temporal';
task_dir = strcat (directory, '/task/');
addpath('sigstar'); % putting * on graphs
% load    
g = (dir([task_dir, '*horizon*.mat']));
for j = 1:length (g)
    exp17(j) = load (g(j).name);
end

%% task parameters for each game
i = 1; % subject #
j = 1; % game #
totalh1=0; totalh6=0; %counting h1 and h6 games
total13 = 0; total22 = 0; %counting number of 13 and 22 conditions
totallm = 0; %counting number of 22 conditions in which av1 ~= av2
totalac = 0; %counting number of all trials in whcih av1 ~= av2 so we can assess accuracy
    for i = 1:length(exp17)
        while size(exp17(i).game(j).key) == [1 10] | size(exp17(i).game(j).key) == [1 5]
            
            sub(i).subID = exp17(i).subjectID + 17000;
            sub(i).isactive = (exp17(i).game(1).RT(1) ~= 0);
            sub(i).g(j).h = exp17(i).game(j).gameLength - 4; %horizon 1 or 6
            
            if sub(i).g(j).h == 1 %counting h1 and h6 games
                totalh1 = totalh1 + 1;
            elseif sub(i).g(j).h == 6
                totalh6 = totalh6 + 1;
            end

            if sum(exp17(i).game(j).nforced ==1) == 1         % uncertainty = 0,1,2  
                sub(i).g(j).uc = 1; % option 1 is uncertain
                total13 = total13 + 1;
                
            elseif sum(exp17(i).game(j).nforced ==1) == 3
                sub(i).g(j).uc = 2; % option 2 is uncertain
                 total13 = total13 + 1;
            elseif sum(exp17(i).game(j).nforced ==1) == 2
                sub(i).g(j).uc = 0;
                total22 = total22 + 1;
            end
            
            if sub(i).g(j).uc ~= 0
                 sub(i).g(j).hi = (exp17(i).game(j).key(5) == sub(i).g(j).uc);    % high info choice, yes =1, no =0
            else
                sub(i).g(j).hi = NaN;
            end
       
            sub(i).g(j).rt5 = exp17(i).game(j).RT(5); %reaction time at trial 5
            
            av1 = sum((2 - exp17(i).game(j).nforced).*exp17(i).game(j).rewards(1, 1:4));
            av2 = sum((exp17(i).game(j).nforced - 1).*exp17(i).game(j).rewards(2, 1:4));
            
            if sub(i).g(j).uc == 0 
                if av1 == av2
                    sub(i).g(j).lm = NaN
                elseif ((av1 < av2) &&(exp17(i).game(j).key(5) == 1))
                    sub(i).g(j).lm = 1;
                    totallm = totallm +1;
                elseif ((av1 > av2) &&(exp17(i).game(j).key(5) == 2))
                    sub(i).g(j).lm = 1;
                    totallm = totallm +1;
                else
                    sub(i).g(j).lm = 0;
% OLDER else; SAME RESULTS             
%                 else
%                   sub(i).g(j).lm = ((av1 < av2) & (exp17(i).game(j).key(5) == 1)) | ((av1 > av2) & (exp17(i).game(j).key(5) == 2)); % low mean choice, yes =1, no =0    
                end
            end
           
            if sub(i).g(j).h == 6  %reaction times (for 6 trials) for horizon 6 
                sub(i).g(j).rt_h6(1:6) = exp17(i).game(j).RT(5:10);
            end
% accuracy
            if av1 == av2
                    sub(i).g(j).ac = NaN
                elseif ((av1 < av2) &&(exp17(i).game(j).key(5) == 2))
                    sub(i).g(j).ac = 1;
                    totalac = totalac +1;
                elseif ((av1 > av2) &&(exp17(i).game(j).key(5) == 1))
                    sub(i).g(j).ac = 1;
                    totalac = totalac +1;
                else
                    sub(i).g(j).ac = 0;
            end
                    
%             sub(i).g(j).ac = exp17(i).game(j).accuracy;

            j = j+1;
        end
        sub(i).ngames = j-1; j=1;
        sub(i).h1games = totalh1; totalh1 = 0;
        sub(i).h6games = totalh6; totalh6 = 0;
        sub(i).games13 = total13; total13 = 0;
        sub(i).games22 = total22; total22 = 0;
        sub(i).gameslm = totallm; totallm = 0;
        sub(i).gamesac = totalac; totalac = 0;
    end

%% average task parameters for each subject
sum_hi1=0; total13_h1 = 0;
sum_hi6=0; total13_h6 = 0;
sum_lm1=0; totallm_h1 = 0;
sum_lm6=0; totallm_h6 = 0;
sum_ac1=0; totalac_h1 = 0;
sum_ac6=0; totalac_h6 = 0;
sum_RT1=0; 
sum_RT6=0;  

    for i = 1:length(sub)
        nn = sub(i).ngames
%       nn = min(sub(i).ngames, 160);
        for j = 1:nn
            if sub(i).g(j).h == 1 && sub(i).g(j).uc ~=0 && sub(i).g(j).hi 
                sum_hi1=sum_hi1+1;
            end
            if sub(i).g(j).uc ~=0 && sub(i).g(j).h == 1
               total13_h1 = total13_h1 + 1;
            end
            if sub(i).g(j).h == 6 && sub(i).g(j).uc ~=0 && sub(i).g(j).hi
                sum_hi6 = sum_hi6 +1;
            end
             if sub(i).g(j).uc ~=0 && sub(i).g(j).h ==6 
                total13_h6 = total13_h6 + 1;
            end
            if sub(i).g(j).uc == 0 && sub(i).g(j).h == 1 && ~isnan(sub(i).g(j).lm) && sub(i).g(j).lm 
               sum_lm1 = sum_lm1 + 1;
            end
            if sub(i).g(j).uc ==0 && sub(i).g(j).h ==1 && ~isnan(sub(i).g(j).lm)
               totallm_h1 = totallm_h1 +1;
            end
            if sub(i).g(j).uc ==0 && sub(i).g(j).h == 6 && ~isnan(sub(i).g(j).lm) && sub(i).g(j).lm
               sum_lm6 = sum_lm6 + 1;
            end
            if sub(i).g(j).uc ==0 && sub(i).g(j).h ==6 && ~isnan(sub(i).g(j).lm)
               totallm_h6 = totallm_h6 + 1;
            end
            % AC
            if ~isnan(sub(i).g(j).ac)
                if (sub(i).g(j).h ==1) 
                    sum_ac1 = sum_ac1 + sub(i).g(j).ac;
                    totalac_h1 = totalac_h1 + 1;
                elseif (sub(i).g(j).h ==6) 
                    sum_ac6 = sum_ac6 + sub(i).g(j).ac;
                    totalac_h6 = totalac_h6 + 1;
                end
            end
            % RT
            if (sub(i).g(j).h ==1)
                sum_RT1 = sum_RT1 + sub(i).g(j).rt5;
            elseif (sub(i).g(j).h ==6)
                sum_RT6 = sum_RT6 + sub(i).g(j).rt5;
            end
        end
        
        sub(i).total13_h1 = total13_h1;
        sub(i).total13_h6 = total13_h6;
        sub(i).totallm_h1 = totallm_h1;
        sub(i).totallm_h6 = totallm_h6;
        sub(i).totalac_h1 = totalac_h1;
        sub(i).totalac_h6 = totalac_h6;
        
        sub(i).phi1 = sum_hi1/total13_h1;
        sub(i).phi6 = sum_hi6/total13_h6;
        sub(i).plm1 = sum_lm1/totallm_h1;
        sub(i).plm6 = sum_lm6/totallm_h6;
        sub(i).direct = sub(i).phi6 - sub(i).phi1;
        sub(i).random = sub(i).plm6 - sub(i).plm1;
        sub(i).ac1 = sum_ac1/totalac_h1;
        sub(i).ac6 = sum_ac6/totalac_h6;
        sub(i).RT1 = sum_RT1/sub(i).h1games;
        sub(i).RT6 = sum_RT6/sub(i).h6games;
        
        sum_hi1=0; total13_h1 = 0;
        sum_hi6=0; total13_h6 = 0;
        sum_lm1=0; totallm_h1 = 0;
        sum_lm6=0; totallm_h6 = 0;
        sum_ac1=0; totalac_h1 = 0;
        sum_ac6=0; totalac_h6 = 0;
        sum_RT1=0; 
        sum_RT6=0; 
    end
 %%
 for i=1:length(sub)
     bb(i,1) = sub(i).subID;  bb(i,2) = sub(i).isactive;
%      b(i,3) = task.d.dcount(i); b(i,4) = task.d.time(i);  
     bb(i,5) = sub(i).phi1; bb(i,6) =sub(i).phi6; 
     bb(i,7) = sub(i).plm1; bb(i,8) = sub(i).plm6; 
     bb(i,9) = sub(i).ac1; bb(i,10) = sub(i).ac6; 
     bb(i,11) = sub(i).RT1; bb(i,12) = sub(i).RT6; 
     bb(i,13) = sub(i).direct; bb(i,14) = sub(i).random;
 end
 bb = sortrows (bb, 1, 'descend');
 bb = sortrows (bb, 2);

%% temporal
[temporal, titles, ~] = xlsread ('Temporal_Discounting_Scores.xlsx');
 %% label
 label(17:22)= titles(1,31:36);
 label{1,1} = 'Sub_ID_task'; label{1,6} = 'p(high_info)_h6'; label{1,11} = 'reaction_time_h1';
 label{1,2} = 'is_active'; label{1,7} = 'p(low_mean)_h1'; label{1,12} = 'reaction_time_h6';
 label{1,3} = 'day_task'; label{1,8} = 'p(low_mean)_h6'; label{1,13} = 'directed_exploration';
 label{1,4} = 'time_task'; label{1,9} = 'accuracy_h1'; label{1,14} = 'random_exploration';
 label{1,5} = 'p(high_info)_h1'; label{1,10} = 'accuracy_h6'; label{1,15} = 'gender'; label{1,16} = 'age';
 %% matching Sub_IDs 
 M=0;
 for i=1:length(bb)
     for j=1:length(temporal)
         if bb(i,1) == temporal (j,1)
             M = M+1;
             e(M,1:14) = bb(i,1:14); 
             e(M, 15:16) = temporal (j, 2:3);  %gender, age
             e(M, 17:22) = temporal (j, 31:36); % 5 k's, #todays
         end
     end
 end 
%% gender, age
average_age = mean(e(:,16))
max_age = max(e(:,16))
min_age = min(e(:,16))

number_of_males = length(find(e(:,15)==1))
number_of_females = length(find(e(:,15)==2))

%% plot horizon task basic
phi(1) = mean(e(:,5)); s_phi(1) = std(e(:,5))/sqrt(length(e(:,5)));
phi(2) = mean(e(:,6)); s_phi(2) = std(e(:,6))/sqrt(length(e(:,6)));
plow(1) = mean(e(:,7)); s_plow(1) = std(e(:,7))/sqrt(length(e(:,7)));
plow(2) = mean(e(:,8)); s_plow(2) = std(e(:,8))/sqrt(length(e(:,8)));
%% t test phi & plow
[h, p,~, t] = ttest(e(:,5), e(:, 6)) %phi
[h2, p2,~, t2] = ttest(e(:,7), e(:, 8)) %plow

%% Arizona color palette
AZred = [171,5,32]/256;
AZblue = [12,35,75]/256;
AZcactus = [92, 135, 39]/256;
AZsky = [132, 210, 226]/256;
AZriver = [7, 104, 115]/256;
AZsand = [241, 158, 31]/256;
AZmesa = [183, 85, 39]/256;
AZbrick = [74, 48, 39]/256;
%%
figure(1);
subplot(1,2,1); set(0,'DefaultAxesTitleFontWeight','normal');

plot([1 6], phi,"-", 'marker', 'diamond', 'LineWidth',6,...
    'MarkerSize',30,...
    'MarkerEdgeColor',AZred,...
    'MarkerFaceColor',AZred,...
    'Color', AZred); hold on;
errorbar([1 6], phi, s_phi, 'Color', AZred, 'LineWidth',3); box off;

sigstar({[1,6]},p)

xlim([-2 9])
xticks([1 6])
ylim([.4 .6])
yticks([.4 .5 .6])

xlabel('horizon')
ylabel('p(high info)')
title('directed exploration')
set(gca,'FontSize',40)

subplot(1,2,2);
plot([1 6], plow,"-", 'marker', 'diamond', 'LineWidth',6,...
    'MarkerSize',30,...
    'MarkerEdgeColor',AZblue,...
    'MarkerFaceColor',AZblue,...
    'Color', AZblue); hold on; errorbar([1 6], plow, s_plow, 'Color', AZblue, 'LineWidth',3); box off;

sigstar({[1,6]},p2)

xlim([-2 9])
xticks([1 6])
ylim([.2 .4])
yticks([.2 .3 .4])
xlabel('horizon')
ylabel('p(low mean)')
title('random exploration')

set(gca,'FontSize',40)
annotation('textbox', [0.03, 1, 0, 0], 'string', 'A', 'FontSize',60, 'fontweight','bold');
annotation('textbox', [0.48, 1, 0, 0], 'string', 'B', 'FontSize',60, 'fontweight','bold')
annotation('textbox', [0.024, 0.11, 0, 0], 'String', '- p=.08', 'FontSize',30, 'FitBoxToText', 'on', 'LineStyle', 'none')
annotation('textbox', [0.01, 0.06, 0, 0], 'String', '*** p<.001', 'FontSize',30, 'FitBoxToText', 'on', 'LineStyle', 'none')
%% range of k's and # todays
kk(1).name = '....';
kk(2).name = 'Overall k';
kk(3).name = 'Small k';
kk(4).name = 'Medium k';
kk(5).name = 'Large k';
kk(6).name = 'Geomean k';
kk(7).name = '# today items';
kk(1).min = 'min';
kk(1).max = 'max';
kk(1).mean = 'mean';
for i = 2:7
    kk(i).min = min(e(:,15+i));
    kk(i).max = max(e(:,15+i));
    kk(i).mean = mean(e(:,15+i));
end
%% plot # today items 
figure(2);
subplot(3,2,1)
scatter(e(:,22), e(:,5),100, AZred, '.'); hold on % p high info h1
p = polyfit(e(:,22), e(:,5),1)
f = polyval(p,e(:,22))
plot(e(:,22), f, 'color', AZblue, 'LineWidth',3)
ylabel('p(high info) h1')
% xlabel('# today items')
ylim([0,1.1])
 set(gca,'FontSize',20)
title('directed exploration', 'FontSize', 30)
[r, p] = corr(e(:,22), e(:,5));
text(1,1,strcat('r =', {' '},num2str(round(r*100)/100),' ; p =',{' '}, num2str(round(p*1000)/1000)), 'FontWeight','Normal', 'FontSize',17)

% subaxis(3,2,1, 'Margin',.4)

subplot(3,2,3)
scatter(e(:,22), e(:,6), 100, AZred,'.'); hold on % p high info h6
p = polyfit(e(:,22), e(:,6),1)
f = polyval(p,e(:,22))
plot(e(:,22), f, 'color', AZblue, 'LineWidth',3)
ylabel('p(high info) h6')
% xlabel('# today items')
ylim([0,1])
set(gca,'FontSize',20)

[r, p] = corr(e(:,22), e(:,6));
text(1,1,strcat('r =', {' '},num2str(round(r*100)/100),' ; p =',{' '}, num2str(round(p*1000)/1000)), 'FontWeight','Normal', 'FontSize',17)

subplot(3,2,2)
scatter(e(:,22), e(:,7), 100, AZred,'.'); hold on % p low mean h1
p = polyfit(e(:,22), e(:,7),1)
f = polyval(p,e(:,22))
plot(e(:,22), f, 'color', AZblue, 'LineWidth',3)
ylabel('p(low mean) h1')
% xlabel('# today items')
ylim([0,1.1])
set(gca,'FontSize',20)
title('random exploration', 'FontSize', 30)

[r, p] = corr(e(:,22), e(:,7));
text(1,1,strcat('r =', {' '},num2str(round(r*100)/100),' ; p =',{' '}, num2str(round(p*1000)/1000)), 'FontWeight','Normal', 'FontSize',17)


subplot(3,2,4)
scatter(e(:,22), e(:,8), 100, AZred,'.'); hold on % p low mean h6
p = polyfit(e(:,22), e(:,8),1)
f = polyval(p,e(:,22))
plot(e(:,22), f, 'color', AZblue, 'LineWidth',3)
ylabel('p(low mean) h6')
% xlabel('# today items')
ylim([0,1])
set(gca,'FontSize',20)
[r, p] = corr(e(:,22), e(:,8));
text(1,1,strcat('r =', {' '},num2str(round(r*100)/100),' ; p =',{' '}, num2str(round(p*1000)/1000)), 'FontWeight','Normal', 'FontSize',17)


subplot(3,2,5)
scatter(e(:,22), e(:,13), 100, AZred,'.'); hold on % directed
p = polyfit(e(:,22), e(:,13),1)
f = polyval(p,e(:,22))
plot(e(:,22), f, 'color', AZblue, 'LineWidth',3)
ylabel('directed exp.')
xlabel('# today items')
ylim([-.6,.65])
set(gca,'FontSize',20)
[r, p] = corr(e(:,22), e(:,13));
text(1,.65,strcat('r =', {' '},num2str(round(r*100)/100),' ; p =',{' '}, num2str(round(p*1000)/1000)), 'FontWeight','Normal', 'FontSize',17)


subplot(3,2,6)
scatter(e(:,22), e(:,14), 100, AZred,'.'); hold on % random
p = polyfit(e(:,22), e(:,14),1)
f = polyval(p,e(:,22))
plot(e(:,22), f, 'color', AZblue, 'LineWidth',3)
ylabel('random exp.')
xlabel('# today items')
ylim([-.6,.65])
set(gca,'FontSize',20)
[r, p] = corr(e(:,22), e(:,14));
text(1,.65,strcat('r =', {' '},num2str(round(r*100)/100),' ; p =',{' '}, num2str(round(p*1000)/1000)), 'FontWeight','Normal', 'FontSize',17)

annotation('textbox', [0.04, .97, 0, 0], 'string', 'A', 'FontSize',30, 'fontweight','bold');
annotation('textbox', [0.485, .97, 0, 0], 'string', 'B', 'FontSize',30, 'fontweight','bold')
annotation('textbox', [0.04, .67, 0, 0], 'string', 'C', 'FontSize',30, 'fontweight','bold');
annotation('textbox', [0.485, .67, 0, 0], 'string', 'D', 'FontSize',30, 'fontweight','bold')
annotation('textbox', [0.04, .36, 0, 0], 'string', 'E', 'FontSize',30, 'fontweight','bold');
annotation('textbox', [0.485, .36, 0, 0], 'string', 'F', 'FontSize',30, 'fontweight','bold')

%% correlations log overall k
clear R P;
    x=0;
for i=5:16
         [R,P] = corrcoef (e(:,i), log(e(:,17)), 'rows', 'complete');
         if P(1,2) < 1.01
            x=x+1;
            c_a_logk(x).parameter = (label(i));
            c_a_logk(x).temp_index = (label(17));
            c_a_logk(x).r = R(1,2);
            c_a_logk(x).p = P(1,2);
            N=0;
            for k=1:length(e)
                if ~isnan(e(k,i)) && ~isnan(e(k,17))
                    N=N+1;
                end
            end
            c_a_logk(x).N = N;
         end
end
